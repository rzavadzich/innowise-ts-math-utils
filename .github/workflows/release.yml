name: Release

on:
  push:
    branches:
      - main

jobs:
  check-publish-label:
    runs-on: ubuntu-latest
    outputs:
      should-publish: ${{ steps.check.outputs.has-label }}
    steps:
      - name: Check if merged PR had publish label
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=$(gh pr list --repo ${{ github.repository }} --state merged --search "${{ github.sha }}" --json number --jq '.[0].number')
          if [ -z "$PR_NUMBER" ]; then
            echo "has-label=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          HAS_LABEL=$(gh pr view $PR_NUMBER --repo ${{ github.repository }} --json labels --jq '.labels[].name' | grep -c '^publish$' || true)
          echo "has-label=$( [ "$HAS_LABEL" -gt 0 ] && echo true || echo false )" >> $GITHUB_OUTPUT

  publish:
    needs: check-publish-label
    if: needs.check-publish-label.outputs.should-publish == 'true'
    permissions:
      contents: read
      packages: write
    uses: rzavadzich/innowise-ci-workflows/.github/workflows/npm-publish.yml@main
    with:
      tag: latest
      check-version-exists: true
    secrets: inherit

  create-release:
    needs: [check-publish-label, publish]
    if: needs.check-publish-label.outputs.should-publish == 'true'
    permissions:
      contents: write
    uses: rzavadzich/innowise-ci-workflows/.github/workflows/create-release.yml@main
    secrets: inherit
